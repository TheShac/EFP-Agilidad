<div class="wrap">
  <!-- Encabezado y botones -->
  <div class="toolbar">
    <div class="titles">
      <h1>Generar carta empresarial</h1>
      <p class="muted">Solicitud de vinculaci√≥n para pr√°ctica<br>Ingenier√≠a Civil en Computaci√≥n e Inform√°tica ‚Äî Facultad de Ingenier√≠a</p>
    </div>

    <div class="actions">
      <button
        mat-stroked-button
        color="primary"
        (click)="previa()"
        [disabled]="form.invalid"
      >
        <mat-icon>visibility</mat-icon>
        Previa
      </button>

      <button
        mat-flat-button
        color="primary"
        (click)="grabar()"
        [disabled]="form.invalid"
      >
        <mat-icon>save</mat-icon>
        Grabar
      </button>

      <button mat-stroked-button color="warn" (click)="limpiar()">
        <mat-icon>refresh</mat-icon>
        Limpiar
      </button>
    </div>
  </div>

  <!-- üîπ FORMULARIO PRINCIPAL -->
  <form [formGroup]="form">
    <mat-card class="elev">
      <mat-card-content>
        <!-- L√≠nea 1: Tipo de pr√°ctica y Centro -->
        <div class="grid g3">
          <!-- Tipo de pr√°ctica -->
          <mat-form-field appearance="outline">
            <mat-label>Tipo de pr√°ctica </mat-label>
            <mat-select formControlName="tipoPractica" required>
              <mat-option *ngFor="let t of tiposPractica" [value]="t">
                {{ t }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('tipoPractica')?.hasError('required')">
              Selecciona un tipo de pr√°ctica
            </mat-error>
          </mat-form-field>

          <!-- Centro educativo -->
          <mat-form-field appearance="outline" class="full-when-sm">
            <mat-label>Empresa</mat-label>
            <mat-select formControlName="centroId" required>
              <mat-option *ngFor="let c of centros" [value]="c.id">
                {{ c.nombre }} ‚Äî {{ c.comuna ?? "s/ comuna" }},
                {{ c.region ?? "s/ regi√≥n" }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('centroId')?.hasError('required')">
              Selecciona una empresa
            </mat-error>
          </mat-form-field>
        </div>

        <mat-divider class="sep"></mat-divider>

        <!-- L√≠nea 2: Estudiantes -->
        <div class="grid g1">
          <mat-form-field appearance="outline" class="full">
            <mat-label>Participante(s)</mat-label>
            <mat-select formControlName="estudiantesIds" multiple required>
              <mat-option disabled>
                <mat-icon>search</mat-icon>
                <input
                  matInput
                  placeholder="Buscar estudiante‚Ä¶"
                  (keyup)="
                    studentFilter = $any($event.target).value; _markForCheck()
                  "
                  (click)="$event.stopPropagation()"
                  [value]="studentFilter"
                  class="search-input"
                />
              </mat-option>

              <mat-option *ngFor="let e of filteredStudents" [value]="e.rut">
                {{ e.nombre }} ‚Äî Rut {{ e.rut }}
              </mat-option>
            </mat-select>
            <mat-hint>Puede seleccionar uno o m√°s participantes</mat-hint>
            <mat-error *ngIf="form.get('estudiantesIds')?.hasError('required')">
              Selecciona al menos un participante
            </mat-error>
          </mat-form-field>
        </div>

        <mat-divider class="sep"></mat-divider>

        <!-- Supervisor -->
        <div class="grid g1">
          <mat-form-field appearance="outline" class="full">
              <mat-label>Responsable empresarial</mat-label>
            <mat-select formControlName="supervisorId" required>
              <mat-option disabled>
                <mat-icon>search</mat-icon>
                <input
                  matInput
                  placeholder="Buscar nombre‚Ä¶"
                  (keyup)="
                    supervisorFilter = $any($event.target).value;
                    _markForCheck()
                  "
                  (click)="$event.stopPropagation()"
                  [value]="supervisorFilter"
                  class="search-input"
                />
              </mat-option>

              <mat-option *ngFor="let s of filteredSupervisores" [value]="s.id">
                {{ s.trato ? s.trato + " " : "" }}{{ s.nombre }}
              </mat-option>
            </mat-select>
            <mat-hint>Seleccione la persona responsable empresarial</mat-hint>
            <mat-error *ngIf="form.get('supervisorId')?.hasError('required')">
                Selecciona a la responsable empresarial
            </mat-error>
          </mat-form-field>
        </div>

        <mat-divider class="sep"></mat-divider>

        <!-- L√≠nea 3: Periodo -->
        <div class="grid g2">
          <mat-form-field appearance="outline">
            <mat-label>Inicio</mat-label>
            <input
              matInput
              [matDatepicker]="dp2"
              formControlName="periodoInicio"
              required
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="dp2"
            ></mat-datepicker-toggle>
            <mat-datepicker #dp2></mat-datepicker>
            <mat-error *ngIf="form.get('periodoInicio')?.hasError('required')">
              Selecciona la fecha de inicio
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fin</mat-label>
            <input
              matInput
              [matDatepicker]="dp3"
              formControlName="periodoFin"
              [min]="minFechaFin"
              required
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="dp3"
            ></mat-datepicker-toggle>
            <mat-datepicker #dp3></mat-datepicker>
            <mat-error *ngIf="form.get('periodoFin')?.hasError('required')">
              Selecciona la fecha de t√©rmino
            </mat-error>
            <mat-error *ngIf="form.hasError('periodoInvalido')">
              La fecha de t√©rmino debe ser posterior al inicio
            </mat-error>
          </mat-form-field>
        </div>

        <mat-divider class="sep"></mat-divider>

        <!-- Configuraci√≥n de carta -->
        <div class="grid g2 note-grid">
          <div class="field-block">
            <mat-form-field appearance="outline">
              <mat-label>Referencia de la carta</mat-label>
              <input
                matInput
                formControlName="referencia"
                placeholder="SOLICITUD DE AUTORIZACION PARA ACTIVIDAD EMPRESARIAL"
              />
            </mat-form-field>
            <small class="field-note">
              Se usar√° en la l√≠nea REF. del documento empresarial
            </small>
          </div>

          <div class="field-block">
            <mat-form-field appearance="outline">
              <mat-label>Folio (opcional)</mat-label>
              <input
                matInput
                formControlName="folioManual"
                placeholder="Se usar√° en PHG N¬∞ ..."
              />
            </mat-form-field>
            <small class="field-note">
              Si lo dejas vac√≠o, se usar√° el folio autogenerado del sistema.
            </small>
          </div>
        </div>

        <div class="grid g2">
          <mat-form-field appearance="outline">
            <mat-label>Nombre Jefatura de √Årea</mat-label>
            <input matInput formControlName="jefaturaNombre" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Cargo Jefatura de √Årea</mat-label>
            <input matInput formControlName="jefaturaCargo" />
          </mat-form-field>
        </div>

        <div class="meta-note">

        </div>
      </mat-card-content>
    </mat-card>
  </form>
</div>
