<div class="Container Section">
  <div class="Header">
    <div class="Headline">
      <h1>Gestión de Tutores</h1>
      <p class="Muted">Gestión de Supervisores y Tutores de práctica</p>
    </div>

    <div class="Spacer"></div>

    <button mat-flat-button color="primary" (click)="alternarFormulario()" class="BtnAdd" *ngIf="!esJefatura">
      <mat-icon>{{ mostrarFormulario ? 'close' : 'person_add' }}</mat-icon>
      {{ mostrarFormulario ? 'Cerrar' : 'Agregar tutor' }}
    </button>
  </div>

  <mat-card class="FiltersCard Elev">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>search</mat-icon>
        Filtros de Búsqueda
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="FiltersGrid">
        <mat-form-field appearance="outline" class="SearchField">
          <mat-label>Buscar</mat-label>
          <input matInput [(ngModel)]="terminoBusqueda" (ngModelChange)="onFiltersChange()" placeholder="Nombre, email, cargo, RUT..." />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="FormContainer" [class.FormOpen]="mostrarFormulario" *ngIf="!esJefatura">
    @if (mostrarFormulario) {
      <mat-card class="Elev FormCard">
        <mat-card-header class="FormHeader">
          <div class="FormTitleSection">
            <div class="FormIcon">
              <mat-icon>{{ estaEditando ? 'edit' : 'person_add' }}</mat-icon>
            </div>
            <div class="FormTitles">
              <h2>{{ estaEditando ? 'Editar tutor' : 'Agregar tutor' }}</h2>
              <p>{{ estaEditando ? 'Modifica los datos del tutor' : 'Completa los datos para registrar un nuevo tutor' }}</p>
            </div>
          </div>
          <button mat-icon-button (click)="alternarFormulario()" class="CloseFormBtn">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content class="FormContent">
          <form [formGroup]="formularioTutor" class="FormGrid">
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Nombre completo *</mat-label>
                <input matInput formControlName="nombre" placeholder="Ej: Ana Gómez" />
                @if (formularioTutor.get('nombre')?.invalid && formularioTutor.get('nombre')?.touched) {
                  <mat-error>{{ getErrorNombre() }}</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>RUT *</mat-label>
                <input matInput formControlName="rut" placeholder="12.345.678-9" />
                @if (formularioTutor.get('rut')?.invalid && formularioTutor.get('rut')?.touched) {
                  <mat-error>{{ getErrorRut() }}</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Email</mat-label>
                <input matInput formControlName="correo" type="email" placeholder="correo@ejemplo.com" />
                @if (formularioTutor.get('correo')?.invalid && formularioTutor.get('correo')?.touched) {
                  <mat-error>{{ getErrorCorreo() }}</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Teléfono</mat-label>
                <input matInput formControlName="telefono" placeholder="987654321" type="tel" />
                @if (formularioTutor.get('telefono')?.invalid && formularioTutor.get('telefono')?.touched) {
                  <mat-error>{{ getErrorTelefono() }}</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField FullWidth">
                <mat-label>Dirección</mat-label>
                <input matInput formControlName="direccion" placeholder="Calle 123, Comuna, Región" />
              </mat-form-field>
            </div>

            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Cargo 1</mat-label>
                <input matInput formControlName="cargo1" placeholder="Ej: Tutor académico" />
              </mat-form-field>
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Cargo 2</mat-label>
                <input matInput formControlName="cargo2" placeholder="Ej: Supervisor de práctica" />
              </mat-form-field>
            </div>

            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField FullWidth">
                <mat-label>Universidad de egreso</mat-label>
                <input matInput formControlName="universidad_egreso" placeholder="Universidad de Chile, PUC…" />
              </mat-form-field>
            </div>
          </form>

          <div class="FormActions">
            <button mat-stroked-button (click)="alternarFormulario()" class="CancelBtn">
              Cancelar
            </button>
            <button
              mat-raised-button
              color="primary"
              (click)="estaEditando ? actualizarTutor() : agregarTutor()"
              [disabled]="formularioTutor.invalid"
              class="SubmitBtn">
              <mat-icon>{{ estaEditando ? 'save' : 'person_add' }}</mat-icon>
              {{ estaEditando ? 'Guardar cambios' : 'Añadir' }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <mat-card class="Elev" *ngIf="totalItems > 0">
    <mat-card-content class="ListContainer">
      @if (cargando) {
        <div style="text-align: center; padding: 2rem;">
          <p class="Muted">Cargando tutores...</p>
        </div>
      } @else {
        @for (t of tutores; track t.id) {
          <div class="ListItem">
            <div class="ItemContent">
              <div class="ItemMain">
                <div class="ItemInfo">
                  <h3>{{ t.nombre }}</h3>
                  <p class="Muted">{{ t.correo || 'Sin email' }}</p>
                </div>
              </div>

              <div class="ItemRole">
                @if (t.cargo) { <span>{{ t.cargo }}</span> } @else { <span class="Muted">Sin cargo</span> }
              </div>

              <div class="ItemActions">
                <button mat-icon-button color="accent" (click)="verDetalles(t)" title="Ver más información">
                  <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button color="primary" (click)="editarTutor(t)" title="Editar" *ngIf="!esJefatura">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="eliminar(t)" title="Eliminar" *ngIf="!esJefatura">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
        }
      }
    </mat-card-content>

    <!-- PAGINADOR -->
    <div class="list-paginator">
      <mat-paginator
        [length]="totalItems"
        [pageIndex]="pageIndex"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)">
      </mat-paginator>
    </div>
  </mat-card>

  @if (!cargando && totalItems === 0) {
    <mat-card class="Elev Empty">
      <mat-card-content class="Muted EmptyContent">
        <mat-icon>group_off</mat-icon>
        <p>No se encontraron tutores con los filtros seleccionados.</p>
      </mat-card-content>
    </mat-card>
  }

  @if (tutorSeleccionado) {
    <div class="DetailsDialog">
      <div class="DialogOverlay" (click)="cerrarDetalles()"></div>
      <div class="DialogContent">
        <div class="DialogHeader">
          <h2>Información del Tutor</h2>
          <button mat-icon-button (click)="cerrarDetalles()" class="CloseBtn">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="DialogBody">
          <div class="DetailsGrid">
            <div class="DetailItem">
              <label>Nombre completo:</label>
              <span>{{ tutorSeleccionado.nombre }}</span>
            </div>

            <div class="DetailItem">
              <label>RUT:</label>
              <span>{{ tutorSeleccionado.rut || 'No especificado' }}</span>
            </div>

            <div class="DetailItem">
              <label>Email:</label>
              <span>{{ tutorSeleccionado.correo || 'No especificado' }}</span>
            </div>

            <div class="DetailItem">
              <label>Dirección:</label>
              <span>{{ tutorSeleccionado.direccion || 'No especificada' }}</span>
            </div>

            <div class="DetailItem">
              <label>Teléfono:</label>
              <span>{{ tutorSeleccionado.telefono || 'No especificado' }}</span>
            </div>

            <div class="DetailItem">
              <label>Cargo:</label>
              <span>{{ tutorSeleccionado.cargo || 'No especificado' }}</span>
            </div>

            <div class="DetailItem">
              <label>Universidad de egreso:</label>
              <span>{{ tutorSeleccionado.universidad_egreso || 'No especificada' }}</span>
            </div>
          </div>
        </div>

        <div class="DialogActions">
          <button mat-stroked-button (click)="cerrarDetalles()">Cerrar</button>
          <button mat-raised-button color="primary" (click)="editarTutor(tutorSeleccionado!)" *ngIf="!esJefatura">
            <mat-icon>edit</mat-icon>
            Editar tutor
          </button>
        </div>
      </div>
    </div>
  }

  @if (mostrarConfirmarEliminar && tutorAEliminar) {
    <div class="confirm-dialog">
      <div class="dialog-overlay" (click)="cerrarConfirmarEliminar()" tabindex="0"></div>

      <div class="dialog-content confirm-card" (keydown.escape)="cerrarConfirmarEliminar()">
        <div class="confirm-header">
          <div class="warn-icon"><mat-icon>warning_amber</mat-icon></div>
          <h2>Confirmar eliminación</h2>
        </div>

        <div class="confirm-body">
          <p>¿Estás seguro de que quieres eliminar a <b>{{ tutorAEliminar.nombre }}</b>?</p>
          <p class="Muted">Esta acción no se puede deshacer.</p>
        </div>

        <div class="confirm-actions">
          <button mat-stroked-button (click)="cerrarConfirmarEliminar()">Cancelar</button>
          <button mat-flat-button color="warn" (click)="confirmarEliminar()" class="btn-danger">
            <mat-icon>delete</mat-icon> Eliminar
          </button>
        </div>
      </div>
    </div>
  }
</div>
