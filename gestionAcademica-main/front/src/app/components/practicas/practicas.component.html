<div class="Container Section">
  <!-- HEADER -->
  <div class="Header">
    <div class="Headline">
      <h1>Asignación de Prácticas</h1>
      <p class="Muted">Gestión de asignaciones de practicas para los estudiantes</p>
    </div>

    <div class="Spacer"></div>

    <!-- BOTÓN NUEVA ASIGNACIÓN -->
    <button mat-flat-button color="primary" (click)="abrirNuevaAsignacion()" class="BtnAdd">
      <mat-icon>person_add</mat-icon>
      Nueva Asignación
    </button>
  </div>

  <!-- FILTROS DE BÚSQUEDA -->
  <mat-card class="FiltersCard Elev">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>search</mat-icon>
        Filtros de Búsqueda
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="FiltersGrid">
        <mat-form-field appearance="outline" class="SearchField">
          <mat-label>Buscar</mat-label>
          <input matInput [(ngModel)]="terminoBusqueda" placeholder="Nombre, RUT o colegio..." />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        
        <!-- Nuevo filtro: Nivel (Plan) -->
        <mat-form-field appearance="outline" class="FilterField">
          <mat-label>Nivel</mat-label>
          <mat-select [(ngModel)]="nivelSeleccionado">
            <mat-option value="all">Todos los niveles</mat-option>
            <mat-option *ngFor="let n of niveles" [value]="n">{{ n }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="FilterField">
          <mat-label>Tipo de Centro Educativo</mat-label>
          <mat-select [(ngModel)]="colegioSeleccionado">
            <mat-select-trigger>
              {{ colegioSeleccionado === 'all' ? 'Todos los tipos' : (colegioSeleccionado | lowercase) }}
            </mat-select-trigger>
            <mat-option value="all">Todos los tipos</mat-option>
            <mat-option *ngFor="let t of tiposCentro" [value]="t">{{ t | lowercase }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- FORMULARIO (colapsable por botón) -->
  <div class="FormContainer" [class.FormOpen]="mostrarFormulario">
    @if (mostrarFormulario) {
      <mat-card class="Elev FormCard">
        <mat-card-header class="FormHeader">
          <div class="FormTitleSection">
            <div class="FormIcon">
              <mat-icon>person_add</mat-icon>
            </div>
            <div class="FormTitles">
              <h2>Asignar Nueva Práctica</h2>
              <p>Completa los datos para asignar una práctica a un estudiante</p>
            </div>
          </div>
          <button mat-icon-button (click)="cerrarFormulario()" class="CloseFormBtn">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content class="FormContent">
          <form [formGroup]="formularioPractica" class="FormGrid">
            
            <!-- Información del Estudiante -->
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Estudiante *</mat-label>
                <input matInput 
                       placeholder="Escriba nombre o RUT del estudiante..."
                       (input)="filtrarEstudiantes($event)"
                       (focus)="mostrarTodosEstudiantes()
                       "
                       [matAutocomplete]="autoEstudiante"
                       formControlName="estudianteRut">
                <mat-autocomplete #autoEstudiante="matAutocomplete" 
                                  [displayWith]="mostrarEstudiante.bind(this)"
                                  (optionSelected)="onEstudianteSeleccionado($event)">
                  @for (estudiante of estudianteFiltrado; track estudiante.rut) {
                    <mat-option [value]="estudiante">
                      {{ estudiante.nombre }} - {{ estudiante.rut }}
                    </mat-option>
                  }
                </mat-autocomplete>
                @if (formularioPractica.get('estudianteRut')?.hasError('required')) {
                  <mat-error>
                    Debe seleccionar un estudiante
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Centro Educativo *</mat-label>
                <input matInput 
                       placeholder="Escriba nombre, comuna o región del centro..."
                       (input)="filtrarCentros($event)"
                       (focus)="mostrarTodosCentros()"
                       [matAutocomplete]="autoCentro"
                       formControlName="centroId">
                <mat-autocomplete #autoCentro="matAutocomplete" 
                                  [displayWith]="mostrarCentro.bind(this)"
                                  (optionSelected)="onCentroSeleccionado($event)">
                  @for (centro of centroFiltrado; track centro.id) {
                    <mat-option [value]="centro">
                      {{ centro.nombre }} - {{ centro.comuna }}, {{ centro.region }}
                    </mat-option>
                  }
                </mat-autocomplete>
                @if (formularioPractica.get('centroId')?.hasError('required')) {
                  <mat-error>
                    Debe seleccionar un centro educativo
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Información del Colaborador (MULTI 1..2) y Tipo -->
            <div class="FormRow">
              <!-- MULTI: Colaboradores/Supervisores (reemplaza mat-chip-list por mat-chip-grid) -->
<mat-form-field appearance="outline" class="FormField FullWidth">
  <mat-label>Colaboradores / Supervisores *</mat-label>

  <mat-chip-grid #chipGrid aria-label="Colaboradores seleccionados">
    <mat-chip-row *ngFor="let c of selectedColaboradores; let i = index"
                  [removable]="true"
                  (removed)="removerColaborador(c)">
      {{ c.nombre }}{{ c.cargo ? ' (' + c.cargo + ')' : '' }}
      <button matChipRemove type="button" aria-label="Quitar">
        <mat-icon>close</mat-icon>
      </button>
    </mat-chip-row>

    <input
      matInput
      [matChipInputFor]="chipGrid"
      placeholder="Buscar colaborador por nombre, rol o cargo..."
      [matAutocomplete]="autoColabMulti"
      (input)="filtrarColaboradores($event)"
      (focus)="mostrarTodosColaboradores()"
      [disabled]="isMaxColaboradoresSeleccionados()">
  </mat-chip-grid>

  <mat-autocomplete
    #autoColabMulti="matAutocomplete"
    (optionSelected)="onColaboradorSeleccionadoMultiple($event)">
    <mat-option *ngFor="let colaborador of colaboradorFiltrado" [value]="colaborador">
      {{ colaborador.nombre }} - {{ colaborador.tipo || '' }}{{ colaborador.cargo ? ' (' + colaborador.cargo + ')' : '' }}
    </mat-option>
  </mat-autocomplete>

  <mat-hint align="start">Puedes seleccionar hasta 2.</mat-hint>

  <mat-error *ngIf="formularioPractica.get('colaboradoresIds')?.hasError('requiredMin')">
    Debes seleccionar al menos 1 colaborador/supervisor
  </mat-error>
  <mat-error *ngIf="formularioPractica.get('colaboradoresIds')?.hasError('maxSeleccionados')">
    Máximo 2 colaboradores/supervisores
  </mat-error>
</mat-form-field>


              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Tipo de Práctica</mat-label>
                <mat-select formControlName="tipo">
                  @for (tipo of tiposPractica; track tipo) {
                    <mat-option [value]="tipo">{{ tipo }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

            <!-- Fechas y Estado -->
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Fecha de Inicio *</mat-label>
                <input matInput [matDatepicker]="pickerInicio" formControlName="fecha_inicio" [min]="fechaMinimaInicio">
                <mat-datepicker-toggle matIconSuffix [for]="pickerInicio"></mat-datepicker-toggle>
                <mat-datepicker #pickerInicio [startAt]="fechaMinimaInicio"></mat-datepicker>
                @if (formularioPractica.get('fecha_inicio')?.hasError('required')) {
                  <mat-error>
                    Debe seleccionar una fecha de inicio
                  </mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Fecha de Término</mat-label>
                <input matInput [matDatepicker]="pickerTermino" formControlName="fecha_termino" [min]="fechaMinimaTermino">
                <mat-datepicker-toggle matIconSuffix [for]="pickerTermino"></mat-datepicker-toggle>
                <mat-datepicker #pickerTermino></mat-datepicker>
                @if (formularioPractica.get('fecha_termino')?.hasError('fechaAnterior')) {
                  <mat-error>
                    La fecha de término no puede ser anterior a la fecha de inicio
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <!-- Estado -->
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Estado</mat-label>
                <mat-select formControlName="estado">
                  @for (estado of estadosPractica; track estado) {
                    <mat-option [value]="estado">
                      {{ formatearEstado(estado) }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>

          </form>

          <div class="FormActions">
            <button mat-stroked-button (click)="cerrarFormulario()" class="CancelBtn">
              Cancelar
            </button>
            <button mat-raised-button color="primary" (click)="guardarPractica()" class="SubmitBtn">
              <mat-icon>person_add</mat-icon>
              Asignar Práctica
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- LISTADO DE ASIGNACIONES -->
  <div class="AssignmentsList">
    @for (assignment of asignacionesFiltradas(); track assignment.id) {
      <mat-card class="AssignmentCard Elev">
        <mat-card-content>
          <div class="AssignmentContent">
            <!-- Información del estudiante -->
            <div class="StudentInfo">
              <div class="StudentHeader">
                <h3>{{ assignment.estudiante.nombre }}</h3>
                <div class="StudentDetails">
                  <span class="Rut">RUT: {{ assignment.estudiante.rut }}</span>
                </div>
              </div>
            </div>

            <!-- Información del centro educativo -->
            <div class="SchoolInfo">
              <div class="SchoolHeader">
                <mat-icon class="SchoolIcon">school</mat-icon>
                <div class="SchoolDetails">
                  <h4>{{ assignment.centro.nombre }}</h4>
                  <div class="SupervisorInfo">
                    <mat-icon class="LockIcon">supervisor_account</mat-icon>
                    <span>Supervisor: {{ assignment.colaborador.nombre }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Información de la práctica -->
            <div class="PracticeInfo">
              <div class="PracticeDetails">
                <div class="PracticeType">
                  <mat-icon class="TypeIcon">work</mat-icon>
                  <span>{{ assignment.tipo || 'Sin especificar' }}</span>
                </div>
                <div class="DateInfo">
                  <mat-icon class="DateIcon">event</mat-icon>
                  <span>{{ assignment.fechaInicio }} 
                    @if (assignment.fechaTermino) {
                      - {{ assignment.fechaTermino }}
                    } @else {
                      - Sin fecha de término
                    }
                  </span>
                </div>
              </div>
            </div>

            <!-- Estado -->
            <div class="StatusSection">
              <span class="StatusBadge" [ngClass]="assignment.estado.toLowerCase()">
                {{ formatearEstado(assignment.estado) }}
              </span>
            </div>

            <!-- Acción -->
            <div class="ActionSection">
              <button mat-stroked-button (click)="verDetalles(assignment)" class="DetailsBtn">
                Ver Detalles
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- MENSAJE VACÍO -->
  @if (!asignacionesFiltradas().length) {
    <mat-card class="EmptyCard Elev">
      <mat-card-content class="EmptyContent">
        <mat-icon>assignment_turned_in</mat-icon>
        <h3>No se encontraron asignaciones</h3>
        <p>No hay asignaciones que coincidan con los filtros seleccionados.</p>
      </mat-card-content>
    </mat-card>
  }

  <!-- MODAL DE DETALLES -->
  @if (mostrarModalDetalles && practicaSeleccionada) {
    <div class="DetailsDialog">
      <div class="DialogOverlay" (click)="cerrarDetalles()"></div>
      <div class="DialogContent">
        <div class="DialogHeader">
          <h2>Detalles de la Práctica</h2>
          <button mat-icon-button (click)="cerrarDetalles()" class="CloseBtn">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        
        <div class="DialogBody">
          <div class="DetailsSections">
            
            <!-- Información General -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>info</mat-icon>
                Información General
              </h3>
              <div class="DetailsGrid">
                <div class="DetailItem">
                  <label>Estado:</label>
                  <span class="StatusBadge" [ngClass]="practicaSeleccionada.estado.toLowerCase()">
                    {{ formatearEstado(practicaSeleccionada.estado) }}
                  </span>
                </div>
                <div class="DetailItem">
                  <label>Tipo:</label>
                  <span>{{ practicaSeleccionada.tipo || 'Sin especificar' }}</span>
                </div>
                <div class="DetailItem">
                  <label>Fecha de Inicio:</label>
                  <span>{{ practicaSeleccionada.fechaInicio }}</span>
                </div>
                <div class="DetailItem">
                  <label>Fecha de Término:</label>
                  <span>{{ practicaSeleccionada.fechaTermino || 'Sin fecha de término' }}</span>
                </div>
              </div>
            </div>

            <!-- Información del Estudiante -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>person</mat-icon>
                Información del Estudiante
              </h3>
              <div class="DetailsGrid">
                <div class="DetailItem">
                  <label>Nombre:</label>
                  <span>{{ practicaSeleccionada.estudiante.nombre }}</span>
                </div>
                <div class="DetailItem">
                  <label>RUT:</label>
                  <span>{{ practicaSeleccionada.estudiante.rut }}</span>
                </div>
              </div>
            </div>

            <!-- Información del Centro Educativo -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>school</mat-icon>
                Centro Educativo
              </h3>
              <div class="DetailsGrid">
                <div class="DetailItem">
                  <label>Nombre:</label>
                  <span>{{ practicaSeleccionada.centro.nombre }}</span>
                </div>
                <div class="DetailItem">
                  <label>Tipo:</label>
                  <span>{{ practicaSeleccionada.centro.tipo || 'Sin especificar' }}</span>
                </div>
                <div class="DetailItem">
                  <label>Dirección:</label>
                  <span>{{ practicaSeleccionada.centro.direccion || 'Sin especificar' }}</span>
                </div>
              </div>
            </div>

            <!-- Información del Supervisor -->
            <div class="DetailSection">
              <h3 class="SectionTitle">
                <mat-icon>supervisor_account</mat-icon>
                Supervisor
              </h3>
              <div class="DetailsGrid">
                <div class="DetailItem">
                  <label>Nombre:</label>
                  <span>{{ practicaSeleccionada.colaborador.nombre }}</span>
                </div>
                <div class="DetailItem">
                  <label>Email:</label>
                  <span>{{ practicaSeleccionada.colaborador.correo || 'Sin especificar' }}</span>
                </div>
                <div class="DetailItem">
                  <label>Tipo:</label>
                  <span>{{ practicaSeleccionada.colaborador.tipo || 'Sin especificar' }}</span>
                </div>
                <div class="DetailItem">
                  <label>Cargo:</label>
                  <span>{{ practicaSeleccionada.colaborador.cargo || 'Sin especificar' }}</span>
                </div>
              </div>
            </div>

            <!-- Actividades -->
            @if (practicaSeleccionada.actividades && practicaSeleccionada.actividades.length > 0) {
              <div class="DetailSection">
                <h3 class="SectionTitle">
                  <mat-icon>assignment</mat-icon>
                  Actividades ({{ practicaSeleccionada.actividades.length }})
                </h3>
                <div class="ActivitiesList">
                  @for (actividad of practicaSeleccionada.actividades; track actividad.id) {
                    <div class="ActivityItem">
                      <div class="ActivityHeader">
                        <h4>{{ actividad.titulo }}</h4>
                        <span class="ActivityStatus" [ngClass]="actividad.completada ? 'completed' : 'pending'">
                          <mat-icon>{{ actividad.completada ? 'check_circle' : 'schedule' }}</mat-icon>
                          {{ actividad.completada ? 'Completada' : 'Pendiente' }}
                        </span>
                      </div>
                      @if (actividad.descripcion) {
                        <p class="ActivityDescription">{{ actividad.descripcion }}</p>
                      }
                      <div class="ActivityDate">
                        <mat-icon>event</mat-icon>
                        <span>{{ actividad.fecha }}</span>
                      </div>
                    </div>
                  }
                </div>
              </div>
            } @else {
              <div class="DetailSection">
                <h3 class="SectionTitle">
                  <mat-icon>assignment</mat-icon>
                  Actividades
                </h3>
                <p class="NoActivities">No hay actividades registradas para esta práctica.</p>
              </div>
            }

          </div>
        </div>
        
        <div class="DialogActions">
          <button mat-stroked-button (click)="cerrarDetalles()">Cerrar</button>
        </div>
      </div>
    </div>
  }
</div>
