<div class="container section">
  <!-- HEADER -->
  <div class="header">
    <div class="headline">
      <h1>Gestión de Empresas</h1>
      <p class="muted">Registrar, editar y buscar empresas asociadas</p>
    </div>
    <div class="spacer"></div>

    <button mat-flat-button color="primary" (click)="toggleForm()" class="btn-add" *ngIf="!soloLecturaVinculacion">
      <mat-icon>{{ showForm ? 'close' : 'add_business' }}</mat-icon>
      {{ showForm ? 'Cerrar' : 'Agregar Empresa' }}
    </button>
  </div>

  <!-- FILTROS -->
  <div class="filters-section">
    <div class="filters-header">
      <mat-icon>search</mat-icon>
      <h2>Filtros de Búsqueda</h2>
    </div>

    <div class="filters">
      <mat-form-field appearance="outline" class="flex1">
        <mat-label>Buscar</mat-label>
        <input matInput [(ngModel)]="searchTerm" name="searchTerm" />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="role-filter">
        <mat-label>Tipo (filtro)</mat-label>
        <mat-select [(ngModel)]="selectedTipo" name="selectedTipo">
          <mat-option value="all">Todos</mat-option>
          <mat-option value="PARTICULAR">ONG</mat-option>
          <mat-option value="PARTICULAR_SUBVENCIONADO">Publica</mat-option>
          <mat-option value="SLEP">Privada</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- FORMULARIO (crear/editar) -->
  <div class="form-container" [class.form-open]="showForm" *ngIf="!soloLecturaVinculacion">
    <mat-card class="elev form-card" *ngIf="showForm">
      <mat-card-header class="form-header">
        <div class="form-title-section">
          <div class="form-icon"><mat-icon>add_business</mat-icon></div>
          <div class="form-titles">
            <h2>{{ isEditing ? 'Editar centro educativo' : 'Agregar Empresa' }}</h2>
            <p>Completa los datos obligatorios marcados con *</p>
          </div>
        </div>
        <button mat-icon-button (click)="toggleForm()" class="close-form-btn" aria-label="Cerrar formulario">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>

      <mat-card-content class="form-content">
        <form class="form-grid">
          <!-- Básicos -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Nombre de la empresa *</mat-label>
              <input matInput [(ngModel)]="newEmpresas.nombre" name="nombre" required />
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Tipo *</mat-label>
              <mat-select [(ngModel)]="newEmpresas.tipo" name="tipo" required>
                <mat-option value="PARTICULAR">ONG</mat-option>
                <mat-option value="PARTICULAR_SUBVENCIONADO">Publica</mat-option>
                <mat-option value="SLEP">Privada</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Región / Comuna -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Región *</mat-label>
              <mat-select
                [(ngModel)]="newEmpresas.region"
                name="region"
                (selectionChange)="onRegionChange()"
                required
              >
                <mat-option *ngFor="let r of REGIONES" [value]="r.nombre">{{ r.nombre }}</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Comuna *</mat-label>
              <mat-select [(ngModel)]="newEmpresas.comuna" name="comuna" required>
                <mat-option *ngFor="let c of comunasFiltradas" [value]="c">{{ c }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Dirección (único campo) -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field full-width">
              <mat-label>Dirección *</mat-label>
              <input matInput [(ngModel)]="newEmpresas.direccion" name="direccion" required />
            </mat-form-field>
          </div>

          <!-- Contacto del colegio -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Teléfono</mat-label>
              <input matInput [(ngModel)]="newEmpresas.telefono" name="telefono" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Correo de la empresa</mat-label>
              <input matInput type="email" [(ngModel)]="newEmpresas.correo" name="correo" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>URL / Redes sociales</mat-label>
              <input matInput [(ngModel)]="newEmpresas.url_rrss" name="url_rrss" />
            </mat-form-field>
          </div>

          <!-- Convenio -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field full-width">
              <mat-label>Convenio</mat-label>
              <mat-select [(ngModel)]="newEmpresas.convenio" name="convenio">
                <mat-option value="Solicitud directa">Solicitud directa</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Fecha inicio de asociación -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Fecha inicio de asociación</mat-label>
              <input
                matInput
                [matDatepicker]="pickerAsoc"
                [value]="toDate(newEmpresas.fecha_inicio_asociacion)"
                (dateChange)="onFechaAsociacionChange($event.value)"
                placeholder="Selecciona fecha"
              />
              <mat-datepicker-toggle matSuffix [for]="pickerAsoc"></mat-datepicker-toggle>
              <mat-datepicker #pickerAsoc></mat-datepicker>
            </mat-form-field>
          </div>
        </form>
      </mat-card-content>

      <!-- Footer fijo con acciones -->
      <div class="form-footer">
        <button mat-stroked-button color="warn" (click)="toggleForm()">Cancelar</button>
        <button mat-flat-button color="primary" (click)="addOrUpdateCentro()">
          <mat-icon>save</mat-icon>
          {{ isEditing ? 'Guardar cambios' : 'Guardar' }}
        </button>
      </div>
    </mat-card>
  </div>

  <!-- LISTADO -->
    <!-- LISTADO -->
  <mat-card class="elev" *ngIf="totalItems > 0">
    <mat-card-content class="list-container">

      <div class="list-item" *ngFor="let c of centrosEducativos">
        <div class="item-content">
          <!-- Col 1: Nombre + dirección -->
          <div class="col col-main">
            <div class="title truncate">{{ c.nombre }}</div>
            <div class="muted truncate" *ngIf="c.direccion">
              <span>{{ c.direccion }}</span>
            </div>
            <div class="muted truncate">
              {{ c.comuna }}<span *ngIf="c.comuna && c.region">, </span>{{ c.region }}
            </div>
            <div class="muted truncate" *ngIf="c.fecha_inicio_asociacion">
              <span>Asociado desde: {{ c.fecha_inicio_asociacion }}</span>
            </div>
          </div>

          <!-- Col 2: Tipo/Convenio -->
          <div class="col col-type">
            <div class="type-badge truncate">{{ c.tipo }}</div>
            <div class="conv muted truncate" *ngIf="c.convenio">{{ c.convenio }}</div>
          </div>

          <!-- Col 3: Contacto -->
          <div class="col col-contact">
            <div class="contact" *ngIf="c.telefono">
              <mat-icon>call</mat-icon><span class="truncate">{{ c.telefono }}</span>
            </div>
            <div class="contact" *ngIf="c.correo">
              <mat-icon>email</mat-icon><span class="truncate">{{ c.correo }}</span>
            </div>
            <div class="contact" *ngIf="c.url_rrss">
              <mat-icon>link</mat-icon><span class="truncate">{{ c.url_rrss }}</span>
            </div>
          </div>

          <!-- Col 4: acciones -->
          <div class="col col-actions">
            <button mat-icon-button (click)="viewCentro(c)" title="Ver detalles">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="primary" (click)="editCentro(c)" title="Editar" *ngIf="!soloLecturaVinculacion">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="accent" (click)="openContacts(c)" title="Añadir contactos" *ngIf="!soloLecturaVinculacion">
              <mat-icon>person_add</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="askDelete(c)" title="Eliminar" *ngIf="!soloLecturaVinculacion">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>

    </mat-card-content>

    <!-- PAGINADOR -->
    <div class="list-paginator">
      <mat-paginator
        [length]="totalItems"
        [pageIndex]="pageIndex"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)">
      </mat-paginator>
    </div>
  </mat-card>



  <!-- EMPTY -->
  <mat-card *ngIf="!isLoading && totalItems === 0" class="elev empty">
    <mat-card-content class="muted empty__content">
     <mat-icon>school</mat-icon>
     <p>No hay centros que coincidan con el criterio.</p>
    </mat-card-content>
  </mat-card>

  <!-- DIALOG DETALLES -->
  <div class="details-dialog" *ngIf="selectedEmpresas">
    <div class="dialog-overlay" (click)="closeDetails()"></div>

    <div class="dialog-content">
      <div class="dialog-header">
        <h2>Información del Centro</h2>
        <button mat-icon-button (click)="closeDetails()" class="close-btn" aria-label="Cerrar detalles">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="dialog-body" *ngIf="selectedEmpresas">
        <div class="details-grid">
          <div class="detail-item"><label>Nombre:</label><span>{{ selectedEmpresas.nombre }}</span></div>
          <div class="detail-item"><label>Tipo:</label><span>{{ selectedEmpresas.tipo }}</span></div>
          <div class="detail-item"><label>Región:</label><span>{{ selectedEmpresas.region }}</span></div>
          <div class="detail-item"><label>Comuna:</label><span>{{ selectedEmpresas.comuna }}</span></div>
          <div class="detail-item" *ngIf="selectedEmpresas.direccion">
            <label>Dirección:</label><span>{{ selectedEmpresas.direccion }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedEmpresas.telefono">
            <label>Teléfono:</label><span>{{ selectedEmpresas.telefono }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedEmpresas.correo">
            <label>Correo:</label><span>{{ selectedEmpresas.correo }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedEmpresas.url_rrss">
            <label>URL / RRSS:</label><span>{{ selectedEmpresas.url_rrss }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedEmpresas.convenio">
            <label>Convenio:</label><span>{{ selectedEmpresas.convenio }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedEmpresas.fecha_inicio_asociacion">
            <label>Inicio de asociación:</label><span>{{ selectedEmpresas.fecha_inicio_asociacion }}</span>
          </div>

          <div class="detail-item" *ngIf="selectedEmpresas.trabajadores?.length">
            <label>Trabajadores:</label>
            <div *ngFor="let t of selectedEmpresas.trabajadores">
              â€¢ {{ t.rol || 'â€”' }} â€” {{ t.nombre }}
              <span *ngIf="t.rut">({{ t.rut }})</span>
              <span *ngIf="t.correo">â€” {{ t.correo }}</span>
              <span *ngIf="t.telefono">â€” {{ t.telefono }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="dialog-actions">
        <button mat-stroked-button (click)="closeDetails()">Cerrar</button>
        <button mat-raised-button color="primary" (click)="editCentro(selectedEmpresas!)" *ngIf="!soloLecturaVinculacion">
          <mat-icon>edit</mat-icon> Editar
        </button>
      </div>
    </div>
  </div>

  <!-- DIALOG CONFIRMAR eliminación -->
  <div class="confirm-dialog" *ngIf="!soloLecturaVinculacion && pendingDelete">
    <div class="dialog-overlay" (click)="cancelDelete()" tabindex="0"></div>
    <div class="dialog-content confirm-card" (keydown.escape)="cancelDelete()">
      <div class="confirm-header">
        <div class="warn-icon">
          <mat-icon>warning_amber</mat-icon>
        </div>
        <h2>Confirmar eliminación</h2>
      </div>
      <div class="confirm-body">
        <p>¿Estás seguro de que quieres eliminar a <b>{{ pendingDelete!.nombre }}</b>?</p>
        <p class="muted">Esta acción no se puede deshacer.</p>
      </div>
      <div class="confirm-actions">
        <button mat-stroked-button (click)="cancelDelete()">Cancelar</button>
        <button mat-flat-button color="warn" (click)="confirmDelete()" class="btn-danger">
          <mat-icon>delete</mat-icon> Eliminar
        </button>
      </div>
    </div>
  </div>

  <!-- DIALOG Añadir/Editar contactos -->
  <div class="details-dialog" *ngIf="!soloLecturaVinculacion && contactsForCentro">
    <div class="dialog-overlay" (click)="closeContacts()"></div>

    <div class="dialog-content">
      <div class="dialog-header">
        <h2>Añadir/Editar contactos</h2>
        <button mat-icon-button (click)="closeContacts()" class="close-btn" aria-label="Cerrar contactos">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="dialog-body">
        <div class="details-grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="detail-item" style="grid-column: 1 / -1;">
            <label style="font-size:16px">Director</label>
          </div>
          <mat-form-field appearance="outline">
            <mat-label>Nombre</mat-label>
            <input matInput [(ngModel)]="contactosForm.directorNombre" name="directorNombre" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>RUT</mat-label>
            <input matInput [(ngModel)]="contactosForm.directorRut" name="directorRut" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Correo</mat-label>
            <input matInput type="email" [(ngModel)]="contactosForm.directorCorreo" name="directorCorreo" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Teléfono</mat-label>
            <input matInput [(ngModel)]="contactosForm.directorTelefono" name="directorTelefono" />
          </mat-form-field>

          <div class="detail-item" style="grid-column: 1 / -1; margin-top: 8px;">
            <label style="font-size:16px">UTP</label>
          </div>
          <mat-form-field appearance="outline">
            <mat-label>Nombre</mat-label>
            <input matInput [(ngModel)]="contactosForm.utpNombre" name="utpNombre" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>RUT</mat-label>
            <input matInput [(ngModel)]="contactosForm.utpRut" name="utpRut" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Correo</mat-label>
            <input matInput type="email" [(ngModel)]="contactosForm.utpCorreo" name="utpCorreo" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Teléfono</mat-label>
            <input matInput [(ngModel)]="contactosForm.utpTelefono" name="utpTelefono" />
          </mat-form-field>
        </div>
      </div>

      <div class="dialog-actions">
        <button mat-stroked-button (click)="closeContacts()">Cancelar</button>
        <button mat-raised-button color="primary" (click)="saveContactsForCentro()">
          <mat-icon>save</mat-icon>
          Guardar contactos
        </button>
      </div>
    </div>
  </div>
</div>





