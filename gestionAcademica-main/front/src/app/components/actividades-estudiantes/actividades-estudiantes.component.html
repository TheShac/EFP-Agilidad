<div class="Container Section">
  <!-- HEADER -->
  <div class="Header">
    <div class="Headline">
      <h1>Actividades</h1>
      <p class="Muted">Gestión de actividades de las prácticas</p>
    </div>
    <div class="Spacer"></div>
    <button mat-flat-button color="primary" (click)="addActivity()" class="BtnAdd" *ngIf="!esJefatura">
      <mat-icon>{{ mostrarFormulario ? 'close' : 'add' }}</mat-icon>
      {{ mostrarFormulario ? 'Cerrar' : 'Añadir Actividad' }}
    </button>
  </div>

  <!-- FILTROS DE BÚSQUEDA -->
  <mat-card class="FiltersCard Elev">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>search</mat-icon>
        Filtros de Búsqueda
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="FiltersGrid">
        <mat-form-field appearance="outline" class="SearchField">
          <mat-label>Buscar</mat-label>
          <input matInput [(ngModel)]="searchTerm" (ngModelChange)="filterActivities()" placeholder="Buscar por nombre de actividad..." />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        
        <mat-form-field appearance="outline" class="FilterField">
          <mat-label>Mes</mat-label>
          <mat-select [(ngModel)]="selectedMes" (ngModelChange)="onMesChange()">
            <mat-option *ngFor="let mes of meses" [value]="mes.value">
              {{ mes.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- FORMULARIO -->
  <div class="FormContainer" [class.FormOpen]="mostrarFormulario" *ngIf="!esJefatura">
    @if (mostrarFormulario) {
      <mat-card class="Elev FormCard">
        <mat-card-header class="FormHeader">
          <div class="FormTitleSection">
            <div class="FormIcon">
              <mat-icon>{{ estaEditando ? 'edit' : 'add' }}</mat-icon>
            </div>
            <div class="FormTitles">
              <h2>{{ estaEditando ? 'Editar actividad' : 'Agregar actividad' }}</h2>
              <p>{{ estaEditando ? 'Modifica los datos de la actividad' : 'Completa los datos para registrar una nueva actividad' }}</p>
            </div>
          </div>
          <button mat-icon-button (click)="alternarFormulario()" class="CloseFormBtn">
            <mat-icon>close</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content class="FormContent">
          <form [formGroup]="formularioActividad" class="FormGrid">
            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField FullWidth">
                <mat-label>Nombre de la actividad *</mat-label>
                <input matInput formControlName="nombre_actividad" placeholder="Ej: Taller 2: Gestión emocional" />
                @if (formularioActividad.get('nombre_actividad')?.invalid && formularioActividad.get('nombre_actividad')?.touched) {
                  <mat-error>El nombre de la actividad es requerido</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Fecha *</mat-label>
                <input matInput [matDatepicker]="pickerFecha" formControlName="fecha" />
                <mat-datepicker-toggle matIconSuffix [for]="pickerFecha"></mat-datepicker-toggle>
                <mat-datepicker #pickerFecha></mat-datepicker>
                @if (formularioActividad.get('fecha')?.invalid && formularioActividad.get('fecha')?.touched) {
                  <mat-error>La fecha es requerida</mat-error>
                }
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Horario</mat-label>
                <input matInput formControlName="horario" type="time" placeholder="HH:MM" />
                <mat-hint>Formato: HH:MM (24 horas)</mat-hint>
              </mat-form-field>
            </div>

            <div class="FormRow">
              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Ubicación</mat-label>
                <input matInput formControlName="lugar" placeholder="Ej: Sala A, Auditorio, Online" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="FormField">
                <mat-label>Estudiantes</mat-label>
                <input matInput formControlName="estudiantes" placeholder="Ingrese estudiantes" />
              </mat-form-field>
            </div>

            <div class="FormRow">
              <div class="FormField FullWidth">
                <label class="FormLabel">Archivos adjuntos</label>
                <div class="FileUploadContainer" style="margin-top: 8px;">
                  <input 
                    type="file" 
                    #fileInput
                    (change)="onFileSelected($event)"
                    accept=".pdf,.jpg,.jpeg,.png,.gif,.bmp,.webp"
                    multiple
                    style="display: none;"
                    id="fileInput" />
                  <button 
                    type="button"
                    mat-stroked-button 
                    (click)="fileInput.click()"
                    class="FileUploadBtn"
                    [disabled]="estaComprimiendo">
                    <mat-icon>attach_file</mat-icon>
                    {{ archivosSeleccionados.length > 0 ? `Seleccionar más archivos (${archivosSeleccionados.length} archivo${archivosSeleccionados.length > 1 ? 's' : ''})` : 'Seleccionar archivos (PDF, imágenes)' }}
                  </button>
                  
                  @if (estaComprimiendo) {
                    <div class="CompressingIndicator">
                      <mat-spinner diameter="20"></mat-spinner>
                      <span>Comprimiendo archivos...</span>
                    </div>
                  }
                  
                  @if (archivosSeleccionados.length > 0 && !estaComprimiendo) {
                    <div class="FilesList">
                      @for (file of archivosSeleccionados; track $index) {
                        <div class="FileInfo">
                          <mat-icon class="FileIcon">description</mat-icon>
                          <span class="FileName" [title]="file.name">{{ file.name }}</span>
                          <span class="FileSize">({{ formatFileSize(file.size) }})</span>
                          <button 
                            type="button"
                            mat-icon-button 
                            (click)="eliminarArchivo($index)"
                            class="RemoveFileBtn">
                            <mat-icon>close</mat-icon>
                          </button>
                        </div>
                      }
                      @if (archivoZip) {
                        <div class="FileInfo" style="background: #f0fdf4; border-color: #86efac;">
                          <mat-icon class="FileIcon" style="color: #16a34a;">folder_zip</mat-icon>
                          <span class="FileName" [title]="archivoZip.name">{{ archivoZip.name }}</span>
                          <span class="FileSize">({{ formatFileSize(archivoZip.size) }})</span>
                          <span style="font-size: 12px; color: #16a34a; font-weight: 500;">✓ Comprimido</span>
                        </div>
                      }
                    </div>
                  }
                  <mat-hint>Puedes seleccionar múltiples archivos. Se comprimirán automáticamente en un ZIP. Formatos permitidos: PDF, JPG, PNG, GIF, BMP, WEBP</mat-hint>
                </div>
              </div>
            </div>
          </form>

          <div class="FormActions">
            <button mat-stroked-button (click)="alternarFormulario()" class="CancelBtn">
              Cancelar
            </button>
            <button
              mat-raised-button
              color="primary"
              (click)="guardarActividad()"
              [disabled]="formularioActividad.invalid"
              class="SubmitBtn">
              <mat-icon>{{ estaEditando ? 'save' : 'add' }}</mat-icon>
              {{ estaEditando ? 'Guardar cambios' : 'Añadir' }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>

  <!-- TABLA DE ACTIVIDADES -->
  <mat-card class="TableCard Elev" *ngIf="totalItems > 0">
    <mat-card-content class="TableContent">
      <div class="TableWrapper">
        <!-- ENCABEZADOS DE TABLA -->
        <div class="TableHeader">
          <div class="HeaderCell HeaderCell--name">NOMBRE ACTIVIDAD</div>
          <div class="HeaderCell HeaderCell--date">FECHA</div>
          <div class="HeaderCell HeaderCell--time">HORARIO</div>
          <div class="HeaderCell HeaderCell--location">UBICACIÓN</div>
          <div class="HeaderCell HeaderCell--students">ESTUDIANTES</div>
          <div class="HeaderCell HeaderCell--evidence">EVIDENCIAS</div>
          <div class="HeaderCell HeaderCell--actions">ACCIONES</div>
  </div>

        <!-- FILAS DE DATOS -->
        <div class="TableRow" *ngFor="let actividad of filteredActivities">
          <div class="TableCell TableCell--name">
            <div class="ActivityName">{{ actividad.nombre_actividad }}</div>
          </div>
          <div class="TableCell TableCell--date">
            <div class="DateText">{{ formatDate(actividad.fecha) }}</div>
          </div>
          <div class="TableCell TableCell--time">
            <div class="TimeText">{{ actividad.horario || '—' }}</div>
          </div>
          <div class="TableCell TableCell--location">
            <div class="LocationText">{{ actividad.lugar || '—' }}</div>
          </div>
          <div class="TableCell TableCell--students">
            <div class="StudentsText">{{ actividad.estudiantes || '—' }}</div>
          </div>
          <div class="TableCell TableCell--evidence">
            <div class="EvidenceText">
              <button 
                mat-icon-button 
                *ngIf="actividad.archivo_adjunto" 
                (click)="descargarArchivo(actividad.archivo_adjunto!)"
                title="Descargar archivos adjuntos"
                style="padding: 0; width: 24px; height: 24px;">
                <mat-icon style="font-size: 20px; width: 20px; height: 20px;">attach_file</mat-icon>
              </button>
              <span *ngIf="!actividad.archivo_adjunto">—</span>
            </div>
          </div>
          <div class="TableCell TableCell--actions">
            <div class="ActionButtons">
              <button mat-icon-button (click)="viewActivity(actividad)" title="Ver detalles">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button color="primary" (click)="editActivity(actividad)" title="Editar" *ngIf="!esJefatura">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="askDelete(actividad)" title="Eliminar" *ngIf="!esJefatura">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>

    <!-- PAGINADOR -->
    <div class="list-paginator">
      <mat-paginator
        [length]="totalItems"
        [pageIndex]="pageIndex"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        (page)="onPageChange($event)">
      </mat-paginator>
    </div>
  </mat-card>

  <!-- MENSAJE VACÍO -->
  <mat-card class="EmptyCard Elev" *ngIf="filteredActivities.length === 0">
    <mat-card-content class="EmptyContent">
      <mat-icon>event_busy</mat-icon>
      <h3>No hay actividades</h3>
      <p class="Muted">{{ searchTerm ? 'No se encontraron actividades que coincidan con tu búsqueda.' : 'Aún no hay actividades registradas.' }}</p>
    </mat-card-content>
  </mat-card>

  <!-- DIALOG DETALLES -->
  @if (actividadSeleccionada) {
    <div class="DetailsDialog">
      <div class="DialogOverlay" (click)="cerrarDetalles()"></div>
      <div class="DialogContent">
        <div class="DialogHeader">
          <h2>Información de la Actividad</h2>
          <button mat-icon-button (click)="cerrarDetalles()" class="CloseBtn">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <div class="DialogBody">
          <div class="DetailsGrid">
            <div class="DetailItem">
              <label>Nombre de la actividad:</label>
              <span>{{ actividadSeleccionada.nombre_actividad }}</span>
            </div>

            <div class="DetailItem">
              <label>Mes:</label>
              <span>{{ actividadSeleccionada.mes || 'No especificado' }}</span>
            </div>

            <div class="DetailItem">
              <label>Fecha:</label>
              <span>{{ formatDate(actividadSeleccionada.fecha) }}</span>
            </div>

            <div class="DetailItem">
              <label>Horario:</label>
              <span>{{ actividadSeleccionada.horario || 'No especificado' }}</span>
            </div>

            <div class="DetailItem">
              <label>Ubicación:</label>
              <span>{{ actividadSeleccionada.lugar || 'No especificada' }}</span>
            </div>

            <div class="DetailItem">
              <label>Estudiantes:</label>
              <span>{{ actividadSeleccionada.estudiantes || 'No especificados' }}</span>
            </div>
          </div>
        </div>

        <div class="DialogActions">
          <button mat-stroked-button (click)="cerrarDetalles()">Cerrar</button>
          <button mat-raised-button color="primary" (click)="editActivity(actividadSeleccionada!); cerrarDetalles()" *ngIf="!esJefatura">
            <mat-icon>edit</mat-icon>
            Editar actividad
          </button>
        </div>
      </div>
    </div>
  }

  <!-- DIALOG CONFIRMAR ELIMINACIÓN -->
  <div class="confirm-dialog" *ngIf="pendingDelete">
    <div class="dialog-overlay" (click)="cancelDelete()" tabindex="0"></div>
    <div class="dialog-content confirm-card" (keydown.escape)="cancelDelete()">
      <div class="confirm-header">
        <div class="warn-icon">
          <mat-icon>warning_amber</mat-icon>
        </div>
        <h2>Confirmar eliminación</h2>
      </div>
      <div class="confirm-body">
        <p>¿Estás seguro de que quieres eliminar la actividad <b>{{ pendingDelete!.nombre_actividad }}</b>?</p>
        <p class="Muted">Esta acción no se puede deshacer.</p>
      </div>
      <div class="confirm-actions">
        <button mat-stroked-button (click)="cancelDelete()">Cancelar</button>
        <button mat-flat-button color="warn" (click)="confirmDelete()" class="btn-danger">
          <mat-icon>delete</mat-icon> Eliminar
        </button>
      </div>
    </div>
  </div>
</div>